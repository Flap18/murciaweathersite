<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Murcia Weather Site</title>
<style>
    /* RESET B√ÅSICO */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: Arial, sans-serif;
        background-color: #d5e4d9;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    header {
        width: 100%;
        background-color: #3e4a47;
        padding: 10px 0;
    }
    header nav {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
    }
    header nav a {
        color: white;
        text-decoration: none;
        font-weight: bold;
    }
    header nav a:hover {
        text-decoration: underline;
    }

    main {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 20px;
        width: 100%;
        max-width: 1000px;
    }

    /* WIDGETS CLIMA */
    .widget {
        background-color: rgba(62, 74, 71, 0.9);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        width: 90%;
        max-width: 300px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    <!-- Barra de avisos AEMET lista para pegar en Google Sites -->
<div id="alerta-meteo" style="position:relative;font-family:Arial,Helvetica,sans-serif;">

<style>
  /* Encapsulado con #alerta-meteo para evitar conflictos en Google Sites */
  #alerta-meteo .alerta-meteorologica {
    background: #ffcc33; /* amarillo m√°s tirando a naranja (aviso) */
    color: #000;
    font-size: 18px;
    padding: 10px 0;
    width: 100%;
    overflow: hidden;
    white-space: nowrap;
    box-sizing: border-box;
  }

  #alerta-meteo .avisos-wrapper {
    display: flex;
    align-items: center;
    animation: mover 25s linear infinite;
  }

  #alerta-meteo .avisos-container {
    display: flex;
  }

  #alerta-meteo .aviso {
    display: inline-block;
    margin-right: 18px;
    padding: 10px 18px;
    background: #d5e4d9;
    color: #000;
    text-decoration: none;
    border-radius: 6px;
    font-size: 15px;
    transition: transform .15s;
  }

  #alerta-meteo .aviso:hover { transform: translateY(-2px); }

  #alerta-meteo .meta {
    display:flex;
    align-items:center;
    gap:12px;
    margin-left:12px;
    white-space:nowrap;
  }

  #alerta-meteo .estado {
    font-size:13px;
    padding:6px 10px;
    border-radius:6px;
    background: rgba(0,0,0,0.06);
  }

  #alerta-meteo .btn {
    cursor:pointer;
    padding:6px 10px;
    border-radius:6px;
    border:0;
    background:#000;
    color:#fff;
    font-size:13px;
  }

  #alerta-meteo .error {
    color:#800;
    font-weight:600;
    margin-left:10px;
  }

  @keyframes mover {
    from { transform: translateX(100%); }
    to   { transform: translateX(-100%); }
  }

  /* Pausar on hover */
  #alerta-meteo .alerta-meteorologica:hover .avisos-wrapper {
    animation-play-state: paused;
  }

  /* Responsive: reducir tama√±o en m√≥viles */
  @media (max-width:600px){
    #alerta-meteo .alerta-meteorologica { font-size:16px; }
    #alerta-meteo .aviso { padding:8px 12px; font-size:14px; }
    #alerta-meteo .meta { display:none; } /* oculta meta en pantallas peque√±as */
  }
</style>

<div class="alerta-meteorologica" role="region" aria-label="Avisos meteorol√≥gicos">
  <div class="avisos-wrapper" id="avisosWrapper">
    <div class="avisos-container" id="avisos1"></div>
    <div class="avisos-container" id="avisos2"></div>
    <div class="avisos-container" id="avisos3"></div>

    <!-- Zona de estado y control -->
    <div class="meta" id="metaInfo" aria-hidden="false" style="margin-left:20px;">
      <div class="estado" id="estadoText">Cargando avisos‚Ä¶</div>
      <button class="btn" id="btnReintentar" type="button">Reintentar</button>
      <div id="lastUpdated" style="font-size:12px;color:rgba(0,0,0,0.6);">‚Äî</div>
    </div>
  </div>
</div>

<script>
(function(){
  const RSS_URL = "https://www.aemet.es/documentos_d/eltiempo/prediccion/avisos/rss/CAP_AFAC73_RSS.xml";
  // Proxy p√∫blico (puede fallar ocasionalmente). Si falla, ver mensaje y la consola.
  const PROXIES = [
    "https://api.allorigins.win/raw?url=",
    "https://api.allorigins.cf/raw?url=",
    // Si tienes un proxy propio, a√±√°delo aqu√≠ al frente del array:
    // "https://tu-proxy.com/raw?url="
  ];

  const MAX_RETRIES = 3;
  const TIMEOUT_MS = 10000;

  const estadoText = document.getElementById("estadoText");
  const lastUpdated = document.getElementById("lastUpdated");
  const btnReintentar = document.getElementById("btnReintentar");
  const avisosEls = [document.getElementById("avisos1"), document.getElementById("avisos2"), document.getElementById("avisos3")];

  let lastSuccess = null;

  btnReintentar.addEventListener("click", () => {
    cargarAvisos(true);
  });

  function timeoutFetch(resource, options = {}) {
    const { timeout = TIMEOUT_MS } = options;
    return Promise.race([
      fetch(resource, options),
      new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), timeout))
    ]);
  }

  async function fetchWithProxies(url) {
    let lastError = null;
    for (let i=0; i<PROXIES.length; i++) {
      const proxy = PROXIES[i];
      try {
        const r = await timeoutFetch(proxy + encodeURIComponent(url));
        if (!r.ok) throw new Error(`HTTP ${r.status} desde proxy ${proxy}`);
        const text = await r.text();
        return { text, proxy };
      } catch (err) {
        lastError = err;
        console.warn("Proxy fallo:", PROXIES[i], err);
      }
    }
    throw lastError || new Error("No hay proxies disponibles");
  }

  async function cargarAvisos(forzar=false) {
    estadoText.textContent = "Cargando avisos‚Ä¶";
    estadoText.style.background = "transparent";
    let intentos = 0;
    let success = false;
    let lastErr = null;

    while (intentos < MAX_RETRIES && !success) {
      intentos++;
      try {
        const { text, proxy } = await fetchWithProxies(RSS_URL);
        const doc = new DOMParser().parseFromString(text, "text/xml");
        const items = [...doc.querySelectorAll("item")];

        const avisosArr = items
            .filter(i => i.querySelector("title")?.textContent.includes("Aviso. Nivel"))
            .map(i => {
                const titulo = i.querySelector("title").textContent;
                const pub = i.querySelector("pubDate")?.textContent || "";
                const fecha = formatearFecha(pub);
                const url = "https://www.aemet.es/es/eltiempo/prediccion/avisos?p=7330";
                return `<a class="aviso" href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(titulo)} - ${fecha}</a>`;
            });

        const html = avisosArr.join("") || `<span class="aviso">No hay avisos activos</span>`;

        // Rellenar contenedores (duplicados para crear efecto continuo)
        avisosEls.forEach(el => el.innerHTML = html);

        success = true;
        lastSuccess = new Date();
        lastUpdated.textContent = `Actualizado: ${formatDateTime(lastSuccess)} (proxy: ${proxy})`;
        estadoText.textContent = "Avisos cargados";
        estadoText.style.background = "transparent";
      } catch (err) {
        lastErr = err;
        console.error("Error al cargar avisos (intento " + intentos + "):", err);
        estadoText.textContent = `Error cargando (intento ${intentos}/${MAX_RETRIES})`;
        estadoText.style.background = "rgba(0,0,0,0.06)";
        // espera breve antes del siguiente intento
        await sleep(900);
      }
    }

    if (!success) {
      // Mensaje visible y sugerencias b√°sicas en la UI
      avisosEls.forEach(el => el.innerHTML = `<span class="aviso" style="background:#ffd6d6;color:#600;">No se han podido cargar los avisos.</span>`);
      estadoText.innerHTML = `Error: API/proxy no responde <span class="error">[ver consola]</span>`;
      lastUpdated.textContent = `√öltimo intento: ${formatDateTime(new Date())}`;
      // Muestra adem√°s un consejo r√°pido (texto breve)
      console.warn("Diagn√≥stico: comprueba si el proxy p√∫blico est√° operativo, o a√±ade un proxy propio en el array PROXIES del script. Error completo:", lastErr);
    }
  }

  function formatearFecha(f) {
    const d = new Date(f || Date.now());
    if (isNaN(d)) return "-";
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
  }

  function formatDateTime(d){
    return d.toLocaleString();
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function escapeHtml(unsafe){
    return unsafe.replace(/[&<"'>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  // Lanzar carga inicial
  cargarAvisos();

  // Actualizar autom√°ticamente cada 10 minutos (si deseas otro intervalo, cambia el valor)
  setInterval(() => cargarAvisos(), 10 * 60 * 1000);

  // Exponer funci√≥n a consola para pruebas: window.cargarAvisos()
  window.cargarAvisosAvisos = cargarAvisos;

})();
</script>

    .widget h2 { margin-bottom: 10px; font-size: 18px; }
    .weather-icon { font-size: 40px; }
    .description { margin: 8px 0; font-size: 14px; }
    .temperature { font-size: 30px; margin: 8px 0; }
    .temp-range { font-size: 14px; margin: 8px 0; }
    .wind-speed { font-size: 14px; margin-top: 8px; }
    .thermometer { font-size: 16px; }

    /* WIDGET CALIDAD AIRE */
    .aq-widget { cursor: pointer; }
    .aqi-level { font-size: 40px; margin: 10px 0; }
    .pollutants { font-size: 12px; margin-top: 10px; }
    .last-updated { font-size: 12px; color: #d5e4d9; margin-top: 10px; }

    /* COLORES AQI */
    .good { color: #4CAF50; }
    .moderate { color: #FFEB3B; }
    .unhealthy { color: #FF9800; }
    .unhealthy-for-sensitive { color: #FF5722; }
    .very-unhealthy { color: #F44336; }
    .hazardous { color: #D32F2F; }

    footer {
        margin-top: auto;
        padding: 10px;
        background-color: #3e4a47;
        color: white;
        width: 100%;
        text-align: center;
    }

    /* CONTENEDORES RADAR Y SAT√âLITE */
    .container {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
        width: 100%;
        max-width: 1000px;
    }
    .iframe-container {
        width: 48%;
        position: relative;
        padding-bottom: 50%; /* Mantiene proporci√≥n 2:1 */
        height: 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .iframe-container h3 {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        background-color: rgba(0,0,0,0.5);
        padding: 5px;
        font-size: 16px;
        border-radius: 5px;
        z-index: 2;
    }
    .iframe-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
    }

    /* Adaptaci√≥n m√≥vil */
    @media(max-width: 600px){
        .iframe-container { width: 100%; padding-bottom: 60%; }
        header nav { flex-direction: column; gap: 10px; }
    }

</style>
</head>
<body>

<header>
    <nav>
        <a href="index.html">Inicio</a>
        <a href="prevision.html">Previsi√≥n</a>
        <a href="radar-sat.html">Radar/Sat√©lite</a>
        <a href="tiempo-real.html">Tiempo Real</a>
        <a href="aviso-legal.html">Aviso Legal</a>
    </nav>
</header>

<main>
    <!-- WIDGET CLIMA -->
    <div class="widget" id="weather-widget">
        <h2>Ahora</h2>
        <div class="city-name" id="city-name">San Basilio, Murcia</div>
        <div class="weather-icon" id="weather-icon">‚òÄÔ∏è</div>
        <div class="description" id="weather-description">Cargando...</div>
        <div class="temperature" id="temperature">Cargando...</div>
        <div class="temp-range" id="temp-range"></div>
        <div class="wind-speed" id="wind-speed">üí® Cargando...</div>
    </div>

    <!-- WIDGET CALIDAD AIRE -->
    <div class="widget aq-widget" id="air-quality-widget" onclick="window.open('https://aqicn.org/city/spain/murcia/san-basilio-murcia-ciudad/es/m', '_blank')">
        <h2>Calidad del Aire</h2>
        <div class="aqi-level" id="aqi-level">AQI: <span id="aqi-value">Cargando...</span></div>
        <div class="description" id="description">Cargando...</div>
        <div class="pollutants" id="pollutants">Cargando...</div>
        <div class="last-updated" id="last-updated">√öltima actualizaci√≥n: Cargando...</div>
    </div>

    <!-- RADAR Y SAT√âLITE -->
    <div class="container">
        <div class="iframe-container">
            <h3>Radar</h3>
            <iframe src="https://www.meteociel.fr/cartes_obs/radar/lastradar_sp.gif" title="Radar"></iframe>
        </div>
        <div class="iframe-container">
            <h3>Sat√©lite</h3>
            <iframe src="https://neige.meteociel.fr/satellite/anim_airmass_sp.php" title="Sat√©lite"></iframe>
        </div>
    </div>
</main>

<footer>
    Murcia Weather Site &copy; 2025
</footer>

<script>
    // === CLIMA ===
    const weatherApi = 'https://api.open-meteo.com/v1/forecast?latitude=37.9838&longitude=-1.128&current_weather=true&timezone=Europe/Madrid';
    const weatherDescriptions = {
        0:"Despejado",1:"Mayormente despejado",2:"Parcialmente nublado",3:"Nublado",
        45:"Niebla",48:"Niebla escarchada",51:"Llovizna ligera",53:"Llovizna moderada",
        55:"Llovizna densa",61:"Lluvia ligera",63:"Lluvia moderada",65:"Lluvia intensa",
        80:"Chubascos ligeros",81:"Chubascos moderados",82:"Chubascos intensos",
        95:"Tormenta",96:"Tormenta con granizo ligero",99:"Tormenta con granizo fuerte"
    };

    fetch(weatherApi)
        .then(r => r.json())
        .then(data => {
            const w = data.current_weather;
            const code = w.weathercode;
            const isDay = w.is_day===1;
            let icon='‚òÄÔ∏è';
            if(code===0||code===1){ icon=isDay?'‚òÄÔ∏è':'üåô'; }
            else if(code===2||code===3){ icon=isDay?'‚õÖ':'üåô‚òÅÔ∏è'; }
            else if([45,48].includes(code)){ icon='üå´Ô∏è'; }
            else if([51,53,55].includes(code)){ icon=isDay?'üå¶Ô∏è':'üåôüåßÔ∏è'; }
            else if([61,63,65].includes(code)){ icon=isDay?'üåßÔ∏è':'üåôüåßÔ∏è'; }
            else if([80,81,82].includes(code)){ icon=isDay?'üå¶Ô∏è':'üåôüå¶Ô∏è'; }
            else if([95,96,99].includes(code)){ icon=isDay?'‚õàÔ∏è':'üåô‚õàÔ∏è'; }

            const temp = w.temperature.toFixed(1);
            const tempMin = (w.temperature-2).toFixed(1);
            const tempMax = (w.temperature+2).toFixed(1);
            const wind = w.windspeed.toFixed(1);
            const dir = w.winddirection;
            let windDir = '';
            if(dir>=0&&dir<45){windDir='N';}
            else if(dir>=45&&dir<135){windDir='E';}
            else if(dir>=135&&dir<225){windDir='S';}
            else if(dir>=225&&dir<315){windDir='O';}
            else{windDir='N';}

            document.getElementById('weather-icon').innerHTML=icon;
            document.getElementById('weather-description').innerText=weatherDescriptions[code]||"Desconocido";
            document.getElementById('temperature').innerText=temp+'¬∞C';
            document.getElementById('temp-range').innerHTML=`<span class="thermometer" style="color:blue;">üü¶</span> Min: ${tempMin}¬∞C <span class="thermometer" style="color:red;">üü•</span> Max: ${tempMax}¬∞C`;
            document.getElementById('wind-speed').innerHTML=`üí® ${wind} km/h (${windDir})`;
        })
        .catch(err => console.error(err));

    // === CALIDAD AIRE ===
    const aqiApi = 'https://api.waqi.info/feed/@5183/?token=250e8cad495de5606efa20484f8904b22f3a7356';
    fetch(aqiApi)
        .then(r=>r.json())
        .then(data=>{
            const aqi = data.data.aqi;
            const pm25 = data.data.iaqi.pm25.v;
            const pm10 = data.data.iaqi.pm10.v;
            const last = new Date(data.data.time.s);

            const aqiEl = document.getElementById('aqi-value');
            aqiEl.innerText=aqi;
            aqiEl.className=getAqiColorClass(aqi);

            document.getElementById('description').innerText=getAirQualityDesc(aqi);
            document.getElementById('pollutants').innerHTML=`PM2.5: <span class="${getPollutantColorClass(pm25)}">${pm25} ¬µg/m¬≥</span><br>PM10: <span class="${getPollutantColorClass(pm10)}">${pm10} ¬µg/m¬≥</span>`;
            document.getElementById('last-updated').innerText=`√öltima actualizaci√≥n: ${last.toLocaleTimeString()}`;
        }).catch(err=>console.error(err));

    function getAirQualityDesc(aqi){
        if(aqi<=50) return "Buena üåø";
        if(aqi<=100) return "Razonablemente buena üåû";
        if(aqi<=150) return "Regular üò∑";
        if(aqi<=200) return "Desfavorable üò∑";
        if(aqi<=300) return "Muy desfavorable üò∑‚ö†Ô∏è";
        return "Extremadamente desfavorable üõë";
    }
    function getAqiColorClass(aqi){
        if(aqi<=50) return "good";
        if(aqi<=100) return "moderate";
        if(aqi<=150) return "unhealthy";
        if(aqi<=200) return "unhealthy-for-sensitive";
        if(aqi<=300) return "very-unhealthy";
        return "hazardous";
    }
    function getPollutantColorClass(v){
        if(v<=12) return "good";
        if(v<=35) return "moderate";
        if(v<=55) return "unhealthy";
        if(v<=150) return "unhealthy-for-sensitive";
        if(v<=250) return "very-unhealthy";
        return "hazardous";
    }
</script>
</body>
</html>

